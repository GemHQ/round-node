// Generated by CoffeeScript 1.8.0
(function() {
  var Collection, Promise, promisify;

  Promise = require('bluebird');

  promisify = Promise.promisify;

  module.exports = Collection = (function() {
    var _isNumber;

    _isNumber = function(n) {
      return !isNaN(parseFloat(n)) && isFinite(n);
    };

    function Collection(_arg, callback) {
      var client, key, options, resource, value;
      resource = _arg.resource, client = _arg.client, options = _arg.options;
      this.resource = resource;
      this.client = client;
      this._list = [];
      this._hash = {};
      for (key in options) {
        value = options[key];
        this[key] = value;
      }
    }

    Collection.prototype.loadCollection = function(options, query) {
      var resource;
      if (query == null) {
        query = {};
      }
      if (typeof this.resource === 'function') {
        resource = this.resource(query);
      } else {
        resource = this.resource;
      }
      resource.list = promisify(resource.list);
      return resource.list().then((function(_this) {
        return function(data) {
          var key, model, resourceArray, _i, _len, _ref;
          resourceArray = data.elements;
          _this._list = resourceArray.map(function(resource) {
            options.resource = resource;
            options.client = _this.client;
            return new _this.type(options);
          });
          if (_this.key) {
            _this._hash = {};
            _ref = _this._list;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              model = _ref[_i];
              key = model.resource[_this.key];
              _this._hash[key] = model;
            }
          }
          return _this;
        };
      })(this))["catch"](function(error) {
        throw new Error(error);
      });
    };

    Collection.prototype.refresh = function(options) {
      if (options == null) {
        options = {};
      }
      return this.loadCollection(options);
    };

    Collection.prototype.add = function(model) {
      var key;
      if (this.key != null) {
        key = model;
        this._hash[key] = model;
      }
      return this._list = this._list.concat(model);
    };

    Collection.prototype.get = function(key) {
      var model;
      if (key == null) {
        return Promise.resolve(this._list);
      }
      if (_isNumber(key)) {
        model = this._list[key];
      } else {
        model = this._hash[key];
      }
      if (model != null) {
        return Promise.resolve(model);
      } else {
        return Promise.reject("No object in the " + this.type.name + "s collection for that value.");
      }
    };

    Collection.prototype.getAll = function() {
      return this._list;
    };

    return Collection;

  })();

}).call(this);
